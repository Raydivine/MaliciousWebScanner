using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Diagnostics;
using System.IO;
using System.Windows.Forms;
using System.Text.RegularExpressions;

namespace MalwareDevelopment
{
    class ScanMalWeb
    {
        public ScanMalWeb() { }

        

        public List<string> getListOfFoundMalWeb()
        {
            List<string> webList = new List<string>();

            List<string> currentConnections = getListOfCurrentConnections();

            return webList;

        }

        private List<string> getListOfCurrentConnections()
        {
            List<string> currentConnections = new List<string>();

            try
            {
                Process p = new Process();
                ProcessStartInfo pI = new ProcessStartInfo();
                pI.Arguments = "-a -n -o";
                pI.FileName = "netstat.exe";
                pI.UseShellExecute = false;
                pI.WindowStyle = ProcessWindowStyle.Hidden;
                pI.RedirectStandardInput = true;
                pI.RedirectStandardOutput = true;
                pI.RedirectStandardError = true;
                p.StartInfo = pI;
                p.Start();

                string output = p.StandardOutput.ReadToEnd();
                currentConnections = getPublicIpAddrInThisText(output);
            }
            catch(Exception err)
            {
                string errMss = err.Message;
            }
            return currentConnections;
        }

        private List<string> getPublicIpAddrInThisText(string text)
        {
            string publicIpRegex = @"\b(?!(10)|192\.168|172\.(2[0-9]|1[6-9]|3[0-2]))[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}";
            Regex reg = new Regex(publicIpRegex, RegexOptions.IgnoreCase);
            MatchCollection mc = reg.Matches(text);

            List<string> list = mc.Cast<Match>().Select(match => match.Value).ToList();

            return list;
        }

    }
}
