using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using System.Diagnostics;
using System.IO;
using System.Windows.Forms;
using System.Text.RegularExpressions;

namespace MalwareDevelopment
{
    class ScanMalWeb
    {
        public ScanMalWeb() { }

        /* Get list Malware IP Address that current computer connected
         * 
         * Process
         * 1. Get list of IP Address that current computer connected''
         * 2. Get list of Mal Website from txt file
         * 3. Get comman items in this two list
         * 4. Return them
         */
        public List<string> getListOfFoundMalWeb()
        {
            List<string> currentConnections = getListOfCurrentConnections();
            List<string> malWebList = getMalWebList();

            IEnumerable<string> result = currentConnections.Intersect(malWebList);

            return result.ToList();
        }

        /* Get list of IP Address that your computer current connected by using netstat  
         * 
         * Refference
         * https://www.howtogeek.com/98601/easily-monitor-your-computers-internet-connection-activity/
         * 
         * Process
         * 1. Call the netstat.exe and proceed command '-a -n -o'
         * 2. Pass the process's outpiut into 
         */
        private List<string> getListOfCurrentConnections()
        {
            List<string> currentConnections = new List<string>();

            try
            {
                Process p = new Process();
                ProcessStartInfo pI = new ProcessStartInfo();
                pI.Arguments = "-a -n -o";
                pI.FileName = "netstat.exe";
                pI.UseShellExecute = false;
                pI.WindowStyle = ProcessWindowStyle.Hidden;
                pI.RedirectStandardInput = true;
                pI.RedirectStandardOutput = true;
                pI.RedirectStandardError = true;
                p.StartInfo = pI;
                p.Start();

                string result = p.StandardOutput.ReadToEnd();
                currentConnections = getPublicIpAddrInThisText(result);
            }
            catch(Exception err)
            {
                string errMss = err.Message;
            }
            return currentConnections;
        }

        private List<string> getPublicIpAddrInThisText(string text)
        {
            string publicIpRegex = @"\b(?!(10)|192\.168|172\.(2[0-9]|1[6-9]|3[0-2]))[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}";
            Regex reg = new Regex(publicIpRegex, RegexOptions.IgnoreCase);
            MatchCollection mc = reg.Matches(text);

            List<string> list = mc.Cast<Match>().Select(match => match.Value).ToList();

            return list;
        }

        private List<string> getMalWebList()
        {
            string[] lines = System.IO.File.ReadAllLines(@"malwareDomainList.txt");
            return lines.ToList();
        }
        
    }
}
